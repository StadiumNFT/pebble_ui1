<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pebble ‚Äî WOW + Homework MVP</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="css/styles.css" />
  <meta name="description" content="Pebble ‚Äî kid-friendly 3D viewer with Homework Mode." />
</head>
<body>
  <div id="app">
    <header class="app-header">
      <h1>üëã Hi! I'm <span class="pebble-name">Pebble</span></h1>
      <p class="subtitle">Your friendly homework buddy ‚Äî tap a big button below.</p>

      <!-- TABS -->
      <nav class="tabs">
        <button class="tab-btn active" data-tab="tab3d">3D</button>
        <button class="tab-btn" data-tab="tabHomework">Homework</button>
      </nav>
    </header>

    <main class="app-main">
      <!-- 3D TAB -->
      <section class="viewer-card tab-panel" id="tab3d">
        <div id="dropzone" class="dropzone" aria-label="Drop your .glb here">
          <div id="viewer"></div>
          <div class="drop-hint" id="drop-hint">Drop a .glb here or use ‚ÄúLoad Pebble GLB‚Äù.</div>
        </div>
        <div class="viewer-actions">
          <button id="btnLoadGLB" class="btn primary">Load Pebble GLB</button>
          <input type="file" id="fileGLB" accept=".glb,.gltf" style="display:none" />
          <button id="btnTalk" class="btn success">Talk</button>
          <button id="btnCalm" class="btn calm">Calm</button>
          <button id="btnGarden" class="btn garden">Garden</button>
          <button id="btnHomework" class="btn homework">Homework Buddy</button>
        </div>
      </section>

      <!-- HOMEWORK TAB -->
      <section class="homework-card tab-panel hidden" id="tabHomework">
        <div class="hw-grid">
          <div class="hw-controls">
            <label class="label">Grade Level</label>
            <select id="hwGrade">
              <option value="k-2">K‚Äì2</option>
              <option value="3-5" selected>3‚Äì5</option>
              <option value="6-8">6‚Äì8</option>
              <option value="9-12">9‚Äì12</option>
            </select>

            <label class="toggle">
              <input type="checkbox" id="hwExplainLike9" checked />
              <span>Explain like I‚Äôm 9</span>
            </label>

            <label class="toggle">
              <input type="checkbox" id="hwHintFirst" checked />
              <span>Hint first (no spoilers)</span>
            </label>
          </div>

          <div class="hw-inputs">
            <textarea id="hwQuestion" class="chat-input" placeholder="Type the homework question here..."></textarea>
            <div class="hw-buttons">
              <button id="hwHintBtn" class="btn primary">Get Hint</button>
              <button id="hwNextBtn" class="btn garden">Show Next Step</button>
              <button id="hwAnswerBtn" class="btn success">Reveal Answer</button>
            </div>
          </div>

          <div class="hw-log" id="hwLog" aria-live="polite"></div>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      <div class="footer-row">
        <label class="label">Proxy URL:</label>
        <input id="proxyUrl" class="proxy-input" placeholder="https://your-proxy.example.com" />
        <button id="btnSaveProxy" class="btn">Save</button>
      </div>
      <div class="tiny-note">Keys never live in the front-end. Proxy keeps secrets safe.</div>
    </footer>
  </div>

  <script type="module">
    /* External libs via ESM to avoid bare import issues on GitHub Pages */
    import * as THREE from "https://esm.sh/three@0.162.0";
    import { OrbitControls } from "https://esm.sh/three@0.162.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://esm.sh/three@0.162.0/examples/jsm/loaders/GLTFLoader.js";

    /* Local modules */
    import { initUI } from './js/ui.js';
    import { initViewer, loadGLBFromFile, sayLine } from './js/viewer.js';
    import { initChat } from './js/chat.js';
    import { getProxyURL, setProxyURL } from './js/store.js';
    import { initHomework } from './js/homework.js';

    /* Tabs */
    const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
    const panels = Array.from(document.querySelectorAll('.tab-panel'));
    tabBtns.forEach(btn => btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      panels.forEach(p => p.classList.toggle('hidden', p.id !== id));
    }));

    /* 3D viewer */
    await initViewer({ THREE, OrbitControls, GLTFLoader });

    /* Hook UI buttons */
    initUI({
      onLoadGLBClick: () => document.getElementById('fileGLB').click(),

      onTalkClick: () => sayLine("Hi! I'm Pebble. I love solving homework in fun ways!"),
      onCalmClick: () => sayLine("Deep breath... and relax. Ready when you are."),
      onGardenClick: () => sayLine("Welcome to the Pebble Garden ‚Äî collect stars and grow!"),

      /* IMPORTANT: switch to Homework tab */
      onHomeworkClick: () => {
        // highlight Homework tab
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const hwTabBtn = document.querySelector('.tab-btn[data-tab="tabHomework"]');
        if (hwTabBtn) hwTabBtn.classList.add('active');

        // show Homework panel
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
        const hwPanel = document.getElementById('tabHomework');
        if (hwPanel) {
          hwPanel.classList.remove('hidden');
          hwPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // gentle nudge (ok to remove)
        sayLine("Okay! Type your question, then tap Get Hint.");
      },
    });

    /* GLB file choose + drag/drop */
    document.getElementById('fileGLB').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (file) { document.getElementById('drop-hint').style.display='none'; await loadGLBFromFile(file); }
    });
    const dropzone = document.getElementById('dropzone');
    const dropHint = document.getElementById('drop-hint');
    ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dropzone.classList.add('drag');
    }));
    ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('drag');
    }));
    dropzone.addEventListener('drop', async (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) { dropHint.style.display = 'none'; await loadGLBFromFile(file); }
    });

    /* Proxy URL memory */
    const proxyInput = document.getElementById('proxyUrl');
    proxyInput.value = getProxyURL() || '';
    document.getElementById('btnSaveProxy').addEventListener('click', () => {
      setProxyURL(proxyInput.value.trim());
      alert('Saved proxy URL.');
    });

    /* Homework + Chat boot */
    initHomework();
    initChat({ sayLine });
  </script>
</body>
</html>
